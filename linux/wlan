#!/bin/sh -x

# try to connect to the wrong wlan in order to force netctl-auto to reconnect
# test if we can ping localhost

connection () {
  if timeout 1s ping -c 1 -W 1 -q localhost >/dev/null; then
    # test if we can ping google
    if timeout 1s ping -c 1 -W 1 -q google.com >/dev/null; then
      echo Info: You seem to have internet connection. >&2
      return 0
    else
      return 1
    fi
  else
    echo Error: Can not ping localhost. >&2
    exit 1
  fi
}

if [ "$1" = -t ]; then
  if ! connection; then
    echo "Info: You don't have internet connection." >&2
    exit 1
  else
    exit 0
  fi
fi

if ! connection; then
  cmd="netctl-auto list|grep -v '^\* '|head -n 1|xargs netctl-auto switch-to"
  if [ `id -u` -ne 0 ]; then
    export SUDO_ASKPASS=/usr/lib/ssh/ssh-askpass
    sudo sh -c "$cmd"
  else
    $cmd
  fi
fi
