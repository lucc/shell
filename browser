#!/bin/sh

# general script to start a browser

type=graphical
pipe=false
URL=http://luc42.lima-city.de
# elinks w3m links lynx
text_browser=elinks
# firefox dwb luakit jumanji surf uzbl
graphical_browser=firefox
quick_browser=luakit

usage () {
  local prog=$(basename "$0")
  echo "Usage: $prog [-gt] url"
  echo "       $prog -n [profile] [url]"
  echo "       cat file.html | $prog -p [-gt]"
}
help () {
  usage
  echo
  echo '  -g	open a graphical browser'
  echo '  -t	open a text browser'
  echo '  -p	expect document on stdin (no url allowed)'
  echo '  -n    open a new instance with the given profile (implies -g)'
}

firefox_profiles () {
  local ini=$HOME/.mozilla/firefox/profiles.ini
  grep '^Name=' "$ini" | cut -f 2 -d =
}
firefox_open_profile () {
  local profile
  for profile in $(firefox_profiles); do
    if [ "$profile" = "$1" ]; then
      # TODO
      exec open -na Firefox --args -P "$profile" -no-remote
    fi
  done
  echo "$1 is not a valid profile. Try one of $(firefox_profiles)."
  exit 2
}

text () {
  if [ -t 1 ] || [ -t 2 ]; then
    exec "$text_browser" "$@"
  else
    exec term -e "$text_browser" "$@"
  fi
}

graphical () {
  if pgrep "$graphical_browser" >/dev/null; then
    exec "$graphical_browser" "$@"
  else
    exec "$quick_browser" "$@"
  fi
}

new_graphical () {
  local user=${1:-$USER}
  shift
  exec "$graphical_browser" -new-instance -P "$user" "$@"
}

while getopts hgntpx opt; do
  case $opt in
    h) help; exit;;
    g) type=graphical;;
    n) type=new_graphical;;
    t) type=text;;
    p) pipe=true;;
    x) set -x;;
    *) usage >&2; exit 2;
  esac
done
shift $((OPTIND-1))

if [ $# -eq 1 ] && [ "$1" = - ]; then
  shift
  pipe=true
fi

if $pipe; then
  # save stdin to a file
  file=$(mktemp -t tmp-$$-XXXXXX) || exit 1
  cat > "$file"                  || exit 1
  case $(file --brief --mime-type "$file") in
    text/html)
      mv "$file" "$file.html"
      file=$file.html
      ;;
  esac
  $type "$file"
else
  $type "$@"
fi
